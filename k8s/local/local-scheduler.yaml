---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: ares-local
  namespace: ares-system
  labels:
    app: ares-local
spec:
  selector:
    matchLabels:
      app: ares-local
  template:
    metadata:
      labels:
        app: ares-local
    spec:
      # ✅ FIX 1: Schedule ONLY on GPU nodes
      nodeSelector:
        cloud.google.com/gke-accelerator: nvidia-tesla-t4
      
      # ✅ FIX 2: GPU resource request (ensures scheduled on GPU node)
      containers:
        - name: ares-local
          image: us-east4-docker.pkg.dev/ares-gpu-test/ares-scheduler/ares-scheduler-local:latest
          imagePullPolicy: Always

          # ✅ FIX 3: Request GPU resource
          resources:
            limits:
              nvidia.com/gpu: 1  # Request 1 GPU
            requests:
              cpu: "500m"
              memory: "512Mi"

          env:
            # External IPs for cross-cluster communication
            - name: ARES_REDIS_ADDR
              value: "34.86.46.217:6379"
            - name: ARES_CONTROL_PLANE
              value: "http://34.48.68.132:8080"

            # ✅ FIX 4: Add NODE_NAME via Downward API
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName

            # ✅ FIX 5: Add POD_NAME and POD_NAMESPACE
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace

            # Cluster config
            - name: ARES_CLUSTER_ID
              value: "gke-ares-gpu-worker"
            - name: ARES_REGION
              value: "us-east4"
            - name: ARES_ZONE
              value: "us-east4-a"

            # Namespace for job pods
            - name: ARES_K8S_NAMESPACE
              value: "ares-system"

            # ✅ FIX 6: Add nvidia-smi path hint
            - name: NVIDIA_SMI_PATH
              value: "/usr/bin/nvidia-smi"

            # Logging
            - name: ARES_LOG_LEVEL
              value: "info"

          ports:
            - name: http
              containerPort: 9090
              protocol: TCP

          # ✅ FIX 7: Mount /proc for GPU detection fallback
          volumeMounts:
            - name: proc
              mountPath: /proc
              readOnly: true
            # ✅ FIX 8: Mount nvidia driver (if available)
            - name: nvidia
              mountPath: /usr/local/nvidia
              readOnly: true

          # Health checks
          livenessProbe:
            httpGet:
              path: /health
              port: 9090
            initialDelaySeconds: 30
            periodSeconds: 10

          readinessProbe:
            httpGet:
              path: /health
              port: 9090
            initialDelaySeconds: 10
            periodSeconds: 5
      
      # ✅ FIX 9: Mount volumes
      volumes:
        - name: proc
          hostPath:
            path: /proc
            type: Directory
        - name: nvidia
          hostPath:
            path: /usr/local/nvidia
            type: DirectoryOrCreate
      
      # Service account for Kubernetes API access
      serviceAccountName: ares-local-scheduler
      
      # ✅ FIX 10: Tolerate GPU taints
      tolerations:
        - key: nvidia.com/gpu
          operator: Exists
          effect: NoSchedule